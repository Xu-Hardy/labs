---
title:  Amazon Bedrock Python SDK 体验文生图体验
---

为了更好的做实验，我们现在执行如下指令创建如下目录：

```bash
# 1. 文生图，存到source/img
# 2. 图生图，source/img -> generate/img
# 3. 图生gif，source/img -> generate/img/frames/{name}
# 4. 视频到视频，source/video 切分 -> source/frames/{name} 生成 -> generate/frames/{name} 合成 -> /generate/videos/{name}

mkdir -p ./source/img 
mkdir -p ./source/frames
mkdir -p ./source/videos


mkdir -p ./generate/img
mkdir -p ./generate/frames
mkdir -p ./generate/videos
```

**实验1:文本生成图像示例**

让我们从一个简单的文本到图像示例开始。我们将使用 Boto3 Python SDK 和 Amazon Bedrock Stability.ai Stable Diffusion XL 1.0。我们将传入正向和负向提示并生成图像。下面的代码是 Amazon Web Services 文档的[示例代码](https://docs.aws.amazon.com/bedrock/latest/userguide/model-parameters-diffusion-1-0-text-image.html#model-parameters-diffusion-1-0-code-example).

```python
import os
import json
import time
import io
import base64
import logging
import boto3
from PIL import Image
from botocore.exceptions import ClientError


# 模型和路径
MODEL_ID = "stability.stable-diffusion-xl-v1"
GENERATED_IMAGES = "./source/img"

# 日志设置
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def generate_image_from_text(model_id, body):
    logger.info("Generating image with SDXL model %s", model_id)
    bedrock = boto3.client(service_name="bedrock-runtime")
    response = bedrock.invoke_model(
        body=body, modelId=model_id, accept="application/json", contentType="application/json"
    )
    response_body = json.loads(response.get("body").read())
    # print(response_body)
    base64_image = response_body["artifacts"][0]["base64"]
    print(base64_image)
    image_bytes = base64.b64decode(base64_image.encode("ascii"))

    if response_body["artifacts"][0]["finishReason"] in ["ERROR", "CONTENT_FILTERED"]:
        raise Exception(f"Image generation error: {response_body['artifacts'][0]['finishReason']}")

    return image_bytes


def text_to_image_request(model_id, positive_prompt, negative_prompt):
    body = json.dumps({
        "text_prompts": [
            {"text": positive_prompt, "weight": 1},
            {"text": negative_prompt, "weight": -1},
        ],
        "height": 1024,
        "width": 1024,
        "cfg_scale": 12,
        "sampler": "K_DPMPP_2M",
        "samples": 1,
        "seed": 123456,
        "steps": 25,
        "style_preset": "fantasy-art",
    })

    try:
        image_bytes = generate_image_from_text(model_id, body)
        image = Image.open(io.BytesIO(image_bytes))
        generated_image_path = f"{GENERATED_IMAGES}/image_{int(time.time())}.jpg"
        image.save(generated_image_path, format="JPEG", quality=95)
        logger.info(f"Generated image: {generated_image_path}")
    except ClientError as err:
        logger.error(f"A client error occurred: {err.response['Error']['Message']}")
    except Exception as err:
        logger.error(err.message)


# 设置提示词
POSITIVE_PROMPT = "mythical beast, Phoenix, cinematic lighting, high level of detail, masterpiece, best quality, 8k"
NEGATIVE_PROMPT = "(worst quality:1.5), (low quality:1.5), lowres, bad anatomy, bad hands, watermark"

# 生成图像
text_to_image_request(MODEL_ID, POSITIVE_PROMPT, NEGATIVE_PROMPT)
```



